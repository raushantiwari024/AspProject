{"version":3,"file":"import-visitor.js","sourceRoot":"","sources":["../../../less/visitors/import-visitor.js"],"names":[],"mappings":"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","sourcesContent":["\"use strict\";\r\nObject.defineProperty(exports, \"__esModule\", { value: true });\r\nvar tslib_1 = require(\"tslib\");\r\n/* eslint-disable no-unused-vars */\r\n/**\r\n * @todo - Remove unused when JSDoc types are added for visitor methods\r\n */\r\nvar contexts_1 = tslib_1.__importDefault(require(\"../contexts\"));\r\nvar visitor_1 = tslib_1.__importDefault(require(\"./visitor\"));\r\nvar import_sequencer_1 = tslib_1.__importDefault(require(\"./import-sequencer\"));\r\nvar utils = tslib_1.__importStar(require(\"../utils\"));\r\nvar ImportVisitor = function (importer, finish) {\r\n    this._visitor = new visitor_1.default(this);\r\n    this._importer = importer;\r\n    this._finish = finish;\r\n    this.context = new contexts_1.default.Eval();\r\n    this.importCount = 0;\r\n    this.onceFileDetectionMap = {};\r\n    this.recursionDetector = {};\r\n    this._sequencer = new import_sequencer_1.default(this._onSequencerEmpty.bind(this));\r\n};\r\nImportVisitor.prototype = {\r\n    isReplacing: false,\r\n    run: function (root) {\r\n        try {\r\n            // process the contents\r\n            this._visitor.visit(root);\r\n        }\r\n        catch (e) {\r\n            this.error = e;\r\n        }\r\n        this.isFinished = true;\r\n        this._sequencer.tryRun();\r\n    },\r\n    _onSequencerEmpty: function () {\r\n        if (!this.isFinished) {\r\n            return;\r\n        }\r\n        this._finish(this.error);\r\n    },\r\n    visitImport: function (importNode, visitArgs) {\r\n        var inlineCSS = importNode.options.inline;\r\n        if (!importNode.css || inlineCSS) {\r\n            var context = new contexts_1.default.Eval(this.context, utils.copyArray(this.context.frames));\r\n            var importParent = context.frames[0];\r\n            this.importCount++;\r\n            if (importNode.isVariableImport()) {\r\n                this._sequencer.addVariableImport(this.processImportNode.bind(this, importNode, context, importParent));\r\n            }\r\n            else {\r\n                this.processImportNode(importNode, context, importParent);\r\n            }\r\n        }\r\n        visitArgs.visitDeeper = false;\r\n    },\r\n    processImportNode: function (importNode, context, importParent) {\r\n        var evaldImportNode;\r\n        var inlineCSS = importNode.options.inline;\r\n        try {\r\n            evaldImportNode = importNode.evalForImport(context);\r\n        }\r\n        catch (e) {\r\n            if (!e.filename) {\r\n                e.index = importNode.getIndex();\r\n                e.filename = importNode.fileInfo().filename;\r\n            }\r\n            // attempt to eval properly and treat as css\r\n            importNode.css = true;\r\n            // if that fails, this error will be thrown\r\n            importNode.error = e;\r\n        }\r\n        if (evaldImportNode && (!evaldImportNode.css || inlineCSS)) {\r\n            if (evaldImportNode.options.multiple) {\r\n                context.importMultiple = true;\r\n            }\r\n            // try appending if we haven't determined if it is css or not\r\n            var tryAppendLessExtension = evaldImportNode.css === undefined;\r\n            for (var i = 0; i < importParent.rules.length; i++) {\r\n                if (importParent.rules[i] === importNode) {\r\n                    importParent.rules[i] = evaldImportNode;\r\n                    break;\r\n                }\r\n            }\r\n            var onImported = this.onImported.bind(this, evaldImportNode, context), sequencedOnImported = this._sequencer.addImport(onImported);\r\n            this._importer.push(evaldImportNode.getPath(), tryAppendLessExtension, evaldImportNode.fileInfo(), evaldImportNode.options, sequencedOnImported);\r\n        }\r\n        else {\r\n            this.importCount--;\r\n            if (this.isFinished) {\r\n                this._sequencer.tryRun();\r\n            }\r\n        }\r\n    },\r\n    onImported: function (importNode, context, e, root, importedAtRoot, fullPath) {\r\n        if (e) {\r\n            if (!e.filename) {\r\n                e.index = importNode.getIndex();\r\n                e.filename = importNode.fileInfo().filename;\r\n            }\r\n            this.error = e;\r\n        }\r\n        var importVisitor = this, inlineCSS = importNode.options.inline, isPlugin = importNode.options.isPlugin, isOptional = importNode.options.optional, duplicateImport = importedAtRoot || fullPath in importVisitor.recursionDetector;\r\n        if (!context.importMultiple) {\r\n            if (duplicateImport) {\r\n                importNode.skip = true;\r\n            }\r\n            else {\r\n                importNode.skip = function () {\r\n                    if (fullPath in importVisitor.onceFileDetectionMap) {\r\n                        return true;\r\n                    }\r\n                    importVisitor.onceFileDetectionMap[fullPath] = true;\r\n                    return false;\r\n                };\r\n            }\r\n        }\r\n        if (!fullPath && isOptional) {\r\n            importNode.skip = true;\r\n        }\r\n        if (root) {\r\n            importNode.root = root;\r\n            importNode.importedFilename = fullPath;\r\n            if (!inlineCSS && !isPlugin && (context.importMultiple || !duplicateImport)) {\r\n                importVisitor.recursionDetector[fullPath] = true;\r\n                var oldContext = this.context;\r\n                this.context = context;\r\n                try {\r\n                    this._visitor.visit(root);\r\n                }\r\n                catch (e) {\r\n                    this.error = e;\r\n                }\r\n                this.context = oldContext;\r\n            }\r\n        }\r\n        importVisitor.importCount--;\r\n        if (importVisitor.isFinished) {\r\n            importVisitor._sequencer.tryRun();\r\n        }\r\n    },\r\n    visitDeclaration: function (declNode, visitArgs) {\r\n        if (declNode.value.type === 'DetachedRuleset') {\r\n            this.context.frames.unshift(declNode);\r\n        }\r\n        else {\r\n            visitArgs.visitDeeper = false;\r\n        }\r\n    },\r\n    visitDeclarationOut: function (declNode) {\r\n        if (declNode.value.type === 'DetachedRuleset') {\r\n            this.context.frames.shift();\r\n        }\r\n    },\r\n    visitAtRule: function (atRuleNode, visitArgs) {\r\n        this.context.frames.unshift(atRuleNode);\r\n    },\r\n    visitAtRuleOut: function (atRuleNode) {\r\n        this.context.frames.shift();\r\n    },\r\n    visitMixinDefinition: function (mixinDefinitionNode, visitArgs) {\r\n        this.context.frames.unshift(mixinDefinitionNode);\r\n    },\r\n    visitMixinDefinitionOut: function (mixinDefinitionNode) {\r\n        this.context.frames.shift();\r\n    },\r\n    visitRuleset: function (rulesetNode, visitArgs) {\r\n        this.context.frames.unshift(rulesetNode);\r\n    },\r\n    visitRulesetOut: function (rulesetNode) {\r\n        this.context.frames.shift();\r\n    },\r\n    visitMedia: function (mediaNode, visitArgs) {\r\n        this.context.frames.unshift(mediaNode.rules[0]);\r\n    },\r\n    visitMediaOut: function (mediaNode) {\r\n        this.context.frames.shift();\r\n    }\r\n};\r\nexports.default = ImportVisitor;\r\n//# sourceMappingURL=import-visitor.js.map"]}